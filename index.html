<!DOCTYPE html>
<html lang="ur">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kami Flex — Temp Mail</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",sans-serif;background:#0b1020;color:#eef2ff;display:flex;flex-direction:column;align-items:center;padding:18px}
    .card{width:100%;max-width:920px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
    h1{margin:0 0 10px;font-size:22px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{background:#5b6cff;color:white;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.12)}
    #emailBox{background:rgba(0,0,0,0.25);padding:10px;border-radius:8px;min-width:220px}
    #loader{display:none;margin-left:10px}
    #inbox{list-style:none;padding:0;margin:12px 0;border-top:1px solid rgba(255,255,255,0.04)}
    #inbox li{padding:10px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:pointer}
    #messageContent{white-space:pre-wrap;padding:12px;background:rgba(0,0,0,0.12);border-radius:8px;margin-top:12px;min-height:120px}
    .notice{padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;margin-top:10px;color:#ffd; border:1px solid rgba(255,255,255,0.03)}
    .small{font-size:13px;color:#cfe;}
    .muted{color:#9fb;}
  </style>
</head>
<body>
  <div class="card">
    <h1>🎯 Kami Flex — Temp Mail</h1>
    <div class="row">
      <div id="emailBox">براۓ مہربانی پہلا "Generate" کریں</div>
      <button id="generateBtn">ای میل بنائیں</button>
      <button id="copyBtn" class="secondary">کاپی کریں</button>
      <div id="loader">⏳ لوڈ ہو رہا ہے...</div>
    </div>

    <div class="row" style="margin-top:14px">
      <button id="refreshInbox">Inbox تازہ کریں</button>
      <button id="clearBtn" class="secondary">خالی کریں</button>
      <div style="flex:1"></div>
      <div class="small muted">API پروکسی: <strong>/api/index.js</strong></div>
    </div>

    <h3 style="margin-top:18px">📥 Inbox</h3>
    <ul id="inbox"><li class="muted small">براہِ کرم پہلے ای میل بنائیں یا refresh کریں</li></ul>

    <h3 style="margin-top:18px">📨 Message</h3>
    <div id="messageContent" class="muted small">پیغام یہاں دکھے گا</div>
  </div>

<script>
let currentEmail = "";

function setLoading(on){
  document.getElementById('loader').style.display = on? 'inline-block':'none';
}

// generate email
document.getElementById('generateBtn').addEventListener('click', async ()=>{
  setLoading(true);
  try{
    const res = await fetch('/api/index?op=generate');
    const data = await res.json();
    if(data && data.email){
      currentEmail = data.email;
      document.getElementById('emailBox').innerText = '📧 ' + currentEmail;
      await navigator.clipboard.writeText(currentEmail).catch(()=>{});
      loadInbox();
    } else {
      document.getElementById('emailBox').innerText = '❌ Generate failed';
    }
  }catch(err){
    document.getElementById('emailBox').innerText = '⚠️ Error: '+err.message;
  } finally { setLoading(false); }
});

// copy
document.getElementById('copyBtn').addEventListener('click', async ()=>{
  if(!currentEmail) return alert('پہلے Generate کریں');
  await navigator.clipboard.writeText(currentEmail).catch(()=>{});
  alert("Copied: "+currentEmail);
});

// clear
document.getElementById('clearBtn').addEventListener('click', ()=>{
  currentEmail="";
  document.getElementById('emailBox').innerText='براۓ مہربانی پہلا "Generate" کریں';
  document.getElementById('inbox').innerHTML='<li class="muted small">Inbox خالی</li>';
  document.getElementById('messageContent').innerText="پیغام یہاں دکھے گا";
});

// refresh inbox
document.getElementById('refreshInbox').addEventListener('click', ()=> loadInbox());

// load inbox
async function loadInbox(){
  if(!currentEmail) return;
  const inboxEl=document.getElementById('inbox');
  inboxEl.innerHTML='<li class="muted small">⏳ Loading...</li>';
  try{
    const res=await fetch('/api/index?op=inbox&email='+encodeURIComponent(currentEmail));
    const data=await res.json();
    if(Array.isArray(data) && data.length>0){
      inboxEl.innerHTML="";
      data.forEach(msg=>{
        const li=document.createElement('li');
        li.innerText=`From: ${msg.from} — Subject: ${msg.subject}`;
        li.onclick=()=> loadMessage(msg.id);
        inboxEl.appendChild(li);
      });
    }else{
      inboxEl.innerHTML='<li class="muted small">📭 No messages</li>';
    }
  }catch(err){
    inboxEl.innerHTML='<li class="muted small">⚠️ Error loading inbox</li>';
  }
}

// load single message
async function loadMessage(id){
  const messageEl=document.getElementById('messageContent');
  messageEl.innerText="⏳ Loading...";
  try{
    const res=await fetch('/api/index?op=message&email='+encodeURIComponent(currentEmail)+'&messageid='+id);
    const data=await res.json();
    messageEl.innerText=data.text || data.body || "⚠️ No content";
  }catch(err){
    messageEl.innerText="⚠️ Error loading message";
  }
}
</script>
</body>
</html>
