<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kami Flex ‚Äî Temp Mail</title>
  <style>
    body{font-family:Arial, sans-serif;background:#0d1117;color:#f0f6fc;margin:0;padding:20px;display:flex;justify-content:center}
    .card{width:100%;max-width:800px;background:#161b22;padding:20px;border-radius:12px;box-shadow:0 0 20px rgba(0,0,0,0.5)}
    h1{margin:0 0 15px;color:#58a6ff}
    button{background:#238636;color:white;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;margin-right:10px}
    button.secondary{background:#30363d;color:#c9d1d9}
    #emailBox{padding:10px;background:#21262d;border-radius:6px;min-width:240px;margin-bottom:10px}
    #loader{display:none;margin-top:10px}
    ul{list-style:none;padding:0;margin:10px 0}
    li{padding:8px;border-bottom:1px solid #30363d;cursor:pointer}
    li:hover{background:#21262d}
    #messageContent{padding:12px;background:#0d1117;border:1px solid #30363d;border-radius:6px;min-height:120px;margin-top:12px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="card">
    <h1>üìß Kami Flex ‚Äî Temp Mail</h1>

    <div id="emailBox">Click Generate to get email</div>
    <button id="generateBtn">Generate</button>
    <button id="copyBtn" class="secondary">Copy</button>
    <div id="loader">‚è≥ Loading...</div>

    <div style="margin-top:20px">
      <button id="refreshInbox">Refresh Inbox</button>
      <button id="clearBtn" class="secondary">Clear</button>
    </div>

    <h3>üì• Inbox</h3>
    <ul id="inbox"><li>No messages yet</li></ul>

    <h3>üì® Message</h3>
    <div id="messageContent">Message will appear here</div>
  </div>

<script>
let currentEmail = "";

// Loader
function setLoading(on){
  document.getElementById("loader").style.display = on ? "block" : "none";
}

// Generate
document.getElementById("generateBtn").addEventListener("click", async ()=>{
  setLoading(true);
  try {
    const res = await fetch("/api/index?op=generate");
    const data = await res.json();
    if(data.email){
      currentEmail = data.email;
      document.getElementById("emailBox").innerText = "üìß " + currentEmail;
      await navigator.clipboard.writeText(currentEmail).catch(()=>{});
      loadInbox();
    }
  } catch(e){
    alert("Error generating email");
  } finally {
    setLoading(false);
  }
});

// Copy
document.getElementById("copyBtn").addEventListener("click", async ()=>{
  if(!currentEmail) return alert("Generate first");
  await navigator.clipboard.writeText(currentEmail);
  alert("Copied: " + currentEmail);
});

// Clear
document.getElementById("clearBtn").addEventListener("click", ()=>{
  currentEmail="";
  document.getElementById("emailBox").innerText="Click Generate to get email";
  document.getElementById("inbox").innerHTML="<li>No messages</li>";
  document.getElementById("messageContent").innerText="Message will appear here";
});

// Refresh Inbox
document.getElementById("refreshInbox").addEventListener("click", ()=> loadInbox());

// Load Inbox
async function loadInbox(){
  if(!currentEmail) return;
  const inboxEl = document.getElementById("inbox");
  inboxEl.innerHTML="<li>‚è≥ Loading inbox...</li>";
  try {
    const res = await fetch("/api/index?op=inbox&email="+encodeURIComponent(currentEmail));
    const data = await res.json();
    if(data.length){
      inboxEl.innerHTML="";
      data.forEach(msg=>{
        const li=document.createElement("li");
        li.innerText=`From: ${msg.from} ‚Äî ${msg.subject}`;
        li.onclick=()=> loadMessage(msg.id);
        inboxEl.appendChild(li);
      });
    } else {
      inboxEl.innerHTML="<li>No messages</li>";
    }
  } catch(e){
    inboxEl.innerHTML="<li>Error loading inbox</li>";
  }
}

// Load Message
async function loadMessage(id){
  const msgEl=document.getElementById("messageContent");
  msgEl.innerText="‚è≥ Loading...";
  try {
    const res=await fetch(`/api/index?op=message&email=${encodeURIComponent(currentEmail)}&messageid=${encodeURIComponent(id)}`);
    const data=await res.json();
    msgEl.innerText=data.text || data.body || "No content";
  } catch(e){
    msgEl.innerText="Error loading message";
  }
}
</script>
</body>
</html>
