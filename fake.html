<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kami Flex — Fake Number</title>
  <style>
    :root{
      --bg1: #071024;
      --bg2: #071a2a;
      --card: rgba(255,255,255,0.04);
      --muted: #9aa4b2;
      --accent: #9333ea; /* Kami Flex purple */
      --accent-2: #06b6d4;
    }
    body{
      margin:0;
      font-family:Inter,system-ui,Arial;
      background: linear-gradient(135deg, #041022 0%, #05232b 50%, #071a21 100%);
      color: #e6eef6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:20px;
      display:flex;
      justify-content:center;
    }
    .wrap{max-width:1100px;width:100%}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:56px;height:56px;border-radius:12px;
      background:linear-gradient(135deg,#7c3aed,#ec4899);
      display:flex;align-items:center;justify-content:center;font-weight:bold;color:#fff;
      box-shadow:0 8px 30px rgba(124,58,237,0.15);
    }
    h1{margin:0;font-size:20px}
    .meta{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    select,input{min-width:180px}
    button.primary{background:linear-gradient(90deg,#7c3aed,#ec4899);border:0;color:white;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .card{background:var(--card);padding:16px;border-radius:14px;margin-top:14px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:12px}
    .daily{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .item{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .small{font-size:13px;color:var(--muted)}
    .copy{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.06);color:#cfe8ea;border:0;cursor:pointer}
    .otp{font-weight:700;color:#b7ff6a;margin-left:10px}
    .list{display:grid;gap:8px;margin-top:8px;max-height:360px;overflow:auto;padding-right:6px}
    textarea#log{width:100%;height:120px;margin-top:12px;border-radius:8px;background:#02101a;color:#cfe8ea;border:0;padding:10px;resize:vertical}
    @media(max-width:980px){.daily{grid-template-columns:repeat(2,1fr)}.grid{grid-template-columns:1fr}}
    @media(max-width:560px){.daily{grid-template-columns:1fr}}
    .status {padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted);display:inline-block;margin-left:8px}
    .top-row{display:flex;gap:10px;align-items:center}
    .page-info{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .get-number{background:linear-gradient(90deg,#06b6d4,#0077a3);padding:10px 14px;border-radius:10px;border:0;color:white;cursor:pointer}
    .note{font-size:13px;color:#ffd;margin-top:12px;background:rgba(0,0,0,0.15);padding:10px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">KF</div>
        <div>
          <h1>Kami Flex — Fake Numbers</h1>
          <div class="meta">Styled like TempMail — use /api/fake on server</div>
        </div>
      </div>

      <div style="min-width:260px">
        <div class="top-row">
          <select id="countrySelect"></select>
          <select id="carrierSelect" style="min-width:160px"></select>
        </div>
        <div style="margin-top:8px;text-align:right">
          <span class="small">Page</span>
          <span id="pageInfo" class="page-info">1</span>
        </div>
      </div>
    </header>

    <div class="controls">
      <input id="appInput" placeholder="App ID (e.g. global--AF-93)" value="global--AF-93" />
      <input id="countInput" placeholder="Count (1-20)" value="12" style="width:110px"/>
      <button id="loadBtn" class="primary">Load Numbers</button>
      <button id="getOneBtn" class="get-number">Get + Generate One</button>
      <button id="refreshBtn" class="ghost">Refresh OTPs</button>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="prevBtn" class="ghost">Prev</button>
        <button id="nextBtn" class="ghost">Next</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Daily / Top</h3>
      <div id="daily" class="daily"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">List (page)</h3>
      <div id="list" class="list"></div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <strong>Status:</strong> <span id="statusText" class="status">Idle</span>
        </div>
        <div class="small">API proxy: <code>/api/fake?type=...</code></div>
      </div>
      <textarea id="log" readonly placeholder="Logs & raw responses"></textarea>
    </div>

    <div class="note">Tip: Choose country → click "Load Numbers". Use "Get + Generate One" to request single number (quick test). Copy button copies number.</div>
  </div>

<script>
  // Client-side JS — calls /api/fake
  let currentPage = 1;
  let numbersCache = []; // { number, id, raw, otp }
  const PAGE_SIZE = 20;

  const countrySelect = document.getElementById('countrySelect');
  const carrierSelect = document.getElementById('carrierSelect');
  const appInput = document.getElementById('appInput');
  const countInput = document.getElementById('countInput');
  const dailyEl = document.getElementById('daily');
  const listEl = document.getElementById('list');
  const logEl = document.getElementById('log');
  const statusText = document.getElementById('statusText');
  const pageInfo = document.getElementById('pageInfo');

  function setStatus(t){ statusText.innerText = t; }
  function log(msg){ const ts = new Date().toLocaleTimeString(); logEl.value = `[${ts}] ${msg}\n` + logEl.value; }

  async function api(params = {}) {
    const url = '/api/fake?' + new URLSearchParams(params).toString();
    setStatus('Requesting ' + (params.type||'?'));
    log('GET ' + url);
    const res = await fetch(url, {cache: 'no-store'});
    const text = await res.text();
    log('Response: ' + (text.length>300 ? text.slice(0,300)+'...' : text));
    setStatus('Idle');
    return text;
  }

  // load countries
  async function loadCountries(){
    try{
      const txt = await api({ type:'countries' });
      let data;
      try{ data = JSON.parse(txt); } catch(e){ data = null; }
      countrySelect.innerHTML = '';
      if(Array.isArray(data)){
        data.forEach(c=>{
          const opt = document.createElement('option');
          opt.value = c.code || c.id || (c.country||c.name) || JSON.stringify(c);
          opt.textContent = c.name || c.country || c.code || JSON.stringify(c);
          countrySelect.appendChild(opt);
        });
      } else if(data && Array.isArray(data.data)){
        data.data.forEach(c=>{
          const opt = document.createElement('option');
          opt.value = c.code || c.id || c.name; opt.textContent = c.name || c.country;
          countrySelect.appendChild(opt);
        });
      } else {
        // fallback: show one
        const opt = document.createElement('option'); opt.value='all'; opt.textContent='All (no country data)'; countrySelect.appendChild(opt);
      }
      // also load carriers for first app/country
      await loadCarriers();
    }catch(err){
      log('Countries error: ' + err.message);
      const opt = document.createElement('option'); opt.value='all'; opt.textContent='All (error)'; countrySelect.appendChild(opt);
    }
  }

  async function loadCarriers(){
    const app = appInput.value || '';
    try{
      const txt = await api({ type:'carriers', app });
      let data; try{ data = JSON.parse(txt); } catch(e){ data=null; }
      carrierSelect.innerHTML = '';
      if(Array.isArray(data)){
        data.forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id||c.code||c.name; opt.textContent=c.name||c.code||JSON.stringify(c); carrierSelect.appendChild(opt); });
      } else if(data && Array.isArray(data.data)){
        data.data.forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id||c.code; opt.textContent=c.name||c.code; carrierSelect.appendChild(opt); });
      } else {
        const opt=document.createElement('option'); opt.value=''; opt.textContent='Default'; carrierSelect.appendChild(opt);
      }
    }catch(err){
      log('Carriers error: ' + err.message);
      const opt=document.createElement('option'); opt.value=''; opt.textContent='Default (err)'; carrierSelect.appendChild(opt);
    }
  }

  async function loadPage(page=1){
    currentPage = page;
    pageInfo.innerText = page;
    numbersCache = [];
    dailyEl.innerHTML = '';
    listEl.innerHTML = '';
    const count = parseInt(countInput.value) || 12;
    setStatus('Loading numbers...');
    log('Loading page '+page+' count '+count);
    // call type=number count times (or 1 call that returns array if API supports - we do multiple)
    const calls = Array.from({length: count}, ()=> api({ type:'number', app: appInput.value, carrier: carrierSelect.value }));
    const results = await Promise.allSettled(calls);
    results.forEach((r, i) => {
      const item = { number:'', id:'', raw:'', otp:null };
      if(r.status==='fulfilled'){
        item.raw = r.value;
        try{
          const j = JSON.parse(r.value);
          item.number = j.data?.number || j.number || j.phone || j.msisdn || j.result || '';
          item.id = j.data?.id || j.id || j.request_id || '';
        }catch(e){
          // fallback regex for phone
          const m = (r.value.match(/(\+\d[\d\-\s]{5,}\d)|(\d{6,15})/)||[])[0]||'';
          item.number = m.replace(/\s+/g,'').replace(/-/g,'');
        }
      } else {
        item.raw = 'ERR: ' + (r.reason && r.reason.message ? r.reason.message : String(r.reason));
      }
      numbersCache.push(item);
    });
    renderNumbers();
    await refreshOtps();
    setStatus('Idle');
  }

  function renderNumbers(){
    dailyEl.innerHTML = '';
    listEl.innerHTML = '';
    numbersCache.forEach((n, idx)=>{
      const node = buildRow(n, idx);
      if(idx < 12) dailyEl.appendChild(node);
      else listEl.appendChild(node);
    });
  }

  function buildRow(item, idx){
    const el = document.createElement('div'); el.className='item';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:700">${escapeHtml(item.number || '(no)')}</div><div class="small">id: ${escapeHtml(item.id||'-')}</div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
    const copyBtn = document.createElement('button'); copyBtn.className='copy'; copyBtn.textContent='Copy';
    copyBtn.onclick = async ()=>{ try{ await navigator.clipboard.writeText(item.number||''); copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',1100); }catch(e){ copyBtn.textContent='Err'; setTimeout(()=>copyBtn.textContent='Copy',1100); } };
    const otpSpan = document.createElement('span'); otpSpan.className='otp'; otpSpan.textContent = item.otp || '';
    right.appendChild(copyBtn); right.appendChild(otpSpan);
    el.appendChild(left); el.appendChild(right);
    return el;
  }

  async function refreshOtps(){
    setStatus('Refreshing OTPs...');
    try{
      const txt = await api({ type:'otp' });
      // try to find 4-8 digit codes
      const matches = (txt.match(/\b[0-9]{4,8}\b/g) || []).slice(0,200);
      // attach heuristically
      for(const m of matches){
        let attached=false;
        for(const it of numbersCache){
          if(it.raw && it.raw.includes(m) && !it.otp){ it.otp = m; attached=true; break; }
        }
        if(!attached){
          for(const it of numbersCache){
            if(!it.otp){ it.otp = m; attached=true; break; }
          }
        }
      }
      renderNumbers();
      setStatus('OTP refreshed');
    }catch(err){
      log('OTP error: ' + err.message);
      setStatus('OTP error');
    }
  }

  // get one number quickly
  async function getOne(){
    setStatus('Getting one...');
    try{
      const txt = await api({ type:'number', app: appInput.value, carrier: carrierSelect.value });
      let num='';
      try{ const j = JSON.parse(txt); num = j.data?.number || j.number || j.phone || j.msisdn || ''; }catch(e){
        const m = (txt.match(/(\+\d[\d\-\s]{5,}\d)|(\d{6,15})/)||[])[0]||''; num = m.replace(/\s+/g,'').replace(/-/g,'');
      }
      // prepend to cache and render
      numbersCache.unshift({ number: num, id:'', raw:txt, otp:null });
      if(numbersCache.length>50) numbersCache.pop();
      renderNumbers();
      setStatus('Got one');
    }catch(err){
      log('Get one error: ' + err.message);
      setStatus('Error');
    }
  }

  // helpers
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // UI bindings
  document.getElementById('loadBtn').addEventListener('click', ()=> loadPage(1));
  document.getElementById('getOneBtn').addEventListener('click', getOne);
  document.getElementById('refreshBtn').addEventListener('click', refreshOtps);
  document.getElementById('prevBtn').addEventListener('click', ()=>{ if(currentPage>1) loadPage(currentPage-1); });
  document.getElementById('nextBtn').addEventListener('click', ()=> loadPage(currentPage+1));

  // initial
  (async ()=>{
    await loadCountries();
    await loadPage(1);
  })();

  // country change triggers carriers reload
  countrySelect.addEventListener('change', loadCarriers);
  appInput.addEventListener('change', loadCarriers);
</script>
</body>
</html>
