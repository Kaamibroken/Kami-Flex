<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kami Flex Temp Mail</title>
</head>
<body style="font-family:sans-serif; background:#f0f2f5; margin:0; padding:20px;">

  <h2 style="text-align:center;">📧 Temp Mail Service</h2>

  <!-- Email Generate -->
  <div style="text-align:center; margin:20px;">
    <button id="generateBtn" style="padding:10px 20px; font-size:16px;">Generate Email</button>
    <div id="loader" style="display:none; margin-top:10px;">⏳ Generating...</div>
    <div id="emailBox" style="margin-top:10px; font-weight:bold; color:green;"></div>
  </div>

  <!-- Inbox Section -->
  <h3>📨 Inbox</h3>
  <ul id="inbox" style="background:white; padding:10px; border-radius:8px; list-style:none; min-height:100px;">
    <li style="text-align:center; color:gray;">📭 No messages</li>
  </ul>

  <!-- Message Section -->
  <h3>📩 Message</h3>
  <div id="messageContent" style="background:white; padding:15px; border-radius:8px; min-height:100px;">
    Select a message to view
  </div>

<script>
let currentEmail = "";

// Generate Email
document.getElementById("generateBtn").addEventListener("click", async () => {
  document.getElementById("loader").style.display = "block";
  document.getElementById("emailBox").innerText = "";

  try {
    const res = await fetch("/api/tempmail?action=generate");
    const data = await res.json();

    if (data.email) {
      currentEmail = data.email;
      document.getElementById("emailBox").innerText = "📧 " + currentEmail;

      navigator.clipboard.writeText(currentEmail);
      alert("Copied: " + currentEmail);

      loadInbox();
    }
  } catch (err) {
    alert("⚠️ Error generating email");
  }

  document.getElementById("loader").style.display = "none";
});

// Load Inbox
async function loadInbox() {
  if (!currentEmail) return;

  const inbox = document.getElementById("inbox");
  inbox.innerHTML = "<li style='text-align:center;'>⏳ Loading...</li>";

  try {
    const res = await fetch(`/api/tempmail?action=inbox&email=${currentEmail}`);
    const data = await res.json();

    inbox.innerHTML = "";
    if (data && data.length > 0) {
      data.forEach(msg => {
        const li = document.createElement("li");
        li.style.padding = "8px";
        li.style.cursor = "pointer";
        li.innerText = `📨 ${msg.from} | ${msg.subject}`;
        li.onclick = () => loadMessage(msg.id);
        inbox.appendChild(li);
      });
    } else {
      inbox.innerHTML = "<li style='text-align:center;'>📭 Empty Inbox</li>";
    }
  } catch {
    inbox.innerHTML = "<li style='text-align:center;'>⚠️ Error loading inbox</li>";
  }
}

// Load Message
async function loadMessage(id) {
  const box = document.getElementById("messageContent");
  box.innerText = "⏳ Loading...";

  try {
    const res = await fetch(`/api/tempmail?action=message&email=${currentEmail}&id=${id}`);
    const data = await res.json();
    box.innerText = data.text || "⚠️ No content";
  } catch {
    box.innerText = "⚠️ Error loading message";
  }
}

// Auto refresh inbox
setInterval(loadInbox, 10000);
</script>
</body>
</html>
